<!-- app/views/devise/registrations/edit.html.erb -->
<h2 class="visually-hidden">Edit profile</h2>

<%= simple_form_for(resource, as: resource_name,
      url: registration_path(resource_name),
      html: { method: :put, multipart: true, class: "profile-card mt-3" }) do |f| %>

  <%= f.error_notification %>

  <!-- Avatar -->
  <div class="profile-avatar text-center">
    <% if resource.photo&.attached? %>
      <%= cl_image_tag resource.photo.key, height: 300, width: 400, crop: :thumb, gravity: :face, class: "avatar-xl" %>
    <% else %>
      <a href="#" class="avatar" id="navbarDropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <%= image_tag "avatar-placeholder.png", crop: :thumb, gravity: :face, class: "avatar-xl" %>
      </a>
    <% end %>

    <div class="mt-2">
      <%= f.input :photo, as: :file, label: "Profile picture", input_html: { class: "form-control" } %>
    </div>
  </div>

  <!-- Main fields -->
  <div class="profile-fields">
    <%= f.input :name,     label: "Full name",  placeholder: "Enter your full name" %>
    <%= f.input :username, label: "Username",   placeholder: "Enter your username" %>
    <%= f.input :location,
                as: :select,
                collection: User::Cities,
                label: "Location",   placeholder: "City / Neighborhood" %>
  </div>

  <!-- Toggle Bar + conditional fields -->
  <div data-controller="toggle" class="profile-bar mt-3">
    <div class="form-check mb-2">
      <%= f.check_box :bar,
            class: "form-check-input",
            data: { action: "toggle#switch", toggle_target: "checkbox" } %>
      <%= f.label :bar, "I own a bar / venue", class: "form-check-label ms-1" %>
    </div>

    <div data-toggle-target="panel" class="<%= resource.bar? ? '' : 'd-none' %>">
      <%= f.input :bar_name,    label: "Bar name",    placeholder: "Example: The Corner Pub" %>
      <%= f.input :bar_address, label: "Bar address", placeholder: "Street, number, city" %>
    </div>
  </div>

  <!-- Passwords (Devise) -->
    <% password_has_errors =
        resource.errors[:password].present? ||
        resource.errors[:password_confirmation].present? ||
        resource.errors[:current_password].present? %>

    <div class="mt-3">
      <button class="btn btn-outline-secondary rounded-pill btn-sm"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#passwordCollapse"
              aria-expanded="<%= password_has_errors %>"
              aria-controls="passwordCollapse">
        Change password
      </button>

      <div class="collapse mt-3 <%= 'show' if password_has_errors %>" id="passwordCollapse">
        <div class="card card-body">
          <%= f.input :password,
                      label: "New password",
                      required: false,
                      input_html: { autocomplete: "new-password" } %>

          <%= f.input :password_confirmation,
                      label: "Confirm new password",
                      required: false,
                      input_html: { autocomplete: "new-password" } %>

          <%= f.input :current_password,
                      label: "Current password",
                      hint: "Required to update your password",
                      required: false,
                      input_html: { autocomplete: "current-password" } %>
        </div>
      </div>
    </div>



  <div class="d-grid mt-3">
    <%= f.button :submit, "Save changes", class: "btn btn-profile" %>
  </div>
<% end %>

<!-- Danger zone -->
<div class="mt-3 mb-3 text-center">
  <%= button_to "Delete my account",
        destroy_user_registration_path,
        method: :delete,
        data: { controller: "sweetalert", action: "click->sweetalert#alert" },
        class: "btn btn-outline-danger" %>
</div>
