<div class="events-page">
  <div class="container py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 class="mb-0 page-title">Events</h1>
        <div class="d-flex align-items-center text-muted mt-1">
          <i class="fa-solid fa-location-dot me-2"></i>
          <span><%= current_user.location %></span>
        </div>
      </div>

      <!--  only desktop -->
      <%= link_to "Create new event",
                  new_event_path,
                  class: "btn btn-secondary events-create-btn d-none d-md-inline-block" %>
    </div>


    <div class="events-search">
      <%= form_with url: events_path, method: :get, class: "d-flex" do %>
        <%= text_field_tag :query, params[:query],
              class: "form-control me-3 rounded-4",
              placeholder: "Type a keyword" %>
        <%= submit_tag "Search", name: "", class: "btn btn-primary" %>
      <% end %>
    </div>

    <!-- cards -->
    <div class="events-list row mt-4">
      <% @events.each do |event| %>
        <% my_event_datetime = event.date %>
        <% date = my_event_datetime.strftime("%d/%m/%Y") %>
        <% time = my_event_datetime.strftime("%H:%M") %>

        <div class="col-12 col-lg-4 mb-3 d-flex">
          <div class="glass-card event-card w-100 text-center">
            <div class="card-body">
              <div class="card-date d-flex justify-content-between">
                <p class="pill">Brasileirão</p>
                <p><i class="fa-regular fa-calendar"></i> <%= date %></p>
              </div>

              <div class="card-title">
                <p>
                  <%= image_tag event.match.home_team.shield_path, width: 40 %>
                  &nbsp;x&nbsp;
                  <%= image_tag event.match.away_team.shield_path, width: 40 %>
                </p>
                <h5><%= event.match.title %></h5>
              </div>

              <p class="card-subtitle mb-2"><%= event.name.capitalize %></p>

              <div class="event-info my-3 text-start">
                <h6 class="card-text">
                  <strong><i class="fa-solid fa-location-dot"></i></strong>
                  <%= event.place %> - <%= event.city %>
                </h6>
                <h6 class="card-text">
                  <strong><i class="fa-regular fa-clock"></i></strong>
                  <%= time %>
                </h6>
                <h6 class="card-text">
                  <strong><i class="fa-regular fa-user"></i></strong>
                  Hosted by: <%= event.user.username %>
                </h6>
              </div>

              <%= link_to "See event", event_path(event), class: "card-link btn btn-primary mb-2" %>

              <% attendance = @attendances_by_event[event.id] %>
              <% unless current_user.bar? %>
                <% if attendance.present? %>
                  <%= simple_form_for [event, attendance],
                        url: event_attendance_path(event, attendance),
                        method: :delete do |f| %>
                    <%= f.button :submit,
                          "Cancel presence",
                          class: "btn btn-danger w-100 mt-3 rounded-pill",
                          data: { turbo_method: :delete, controller: "sweetalert", action: "click->sweetalert#alert" } %>
                  <% end %>
                <% elsif Time.current < event.date %>
                  <%= simple_form_for [event, Attendance.new],
                        html: { data: { turbo: "false" } } do |f| %>
                    <%= f.button :submit,
                          "I want to go",
                          class: "btn btn-primary w-100 mt-3 rounded-pill" %>
                  <% end %>
                <% end %>
              <% end %>

            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!--  FINAL só no mobile -->
    <div class="text-center mt-3 d-md-none">
      <%= link_to "Create new event", new_event_path, class: "btn btn-secondary w-100 rounded-pill" %>
    </div>

  </div>
</div>
